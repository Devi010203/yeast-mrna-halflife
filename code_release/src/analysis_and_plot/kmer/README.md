### The programs in this folder are dependent on the main program, please make sure you have run the main program and changed the paths to the relevant files in the relevant scripts.

### select_kmers.py

- **Functionality    Automatically filters “available k-mer” from k-mer enrichment summary tables like `kmer_enrichment_results_all.csv`:
  
  Thresholding by FDR (q-value), |log2FC| and support (a+c), and de-redundancy by reverse complementarity + Hamming distance ≤ 1;
  
  
Also generate equal-length, centered 1bp “mildly de-functionalized” replacement sequences for each k-mer, exported to a text file for direct motif/replacement input to `run_interpretability.py`.

- **Main input**    - `CONFIG[“ALL_CSV”]`: a summary table of k-mer enrichments (usually `kmer_enrichment_results_all.csv`) with columns `k,kmer,a,b,c,d,log2fc,p,q,tag`.
  
  - `CONFIG[“Q_MAX”]`, `ABS_LOG2FC_MIN`, `SUPPORT_MIN`: FDR, effect size, and support screening thresholds.
  
  - `CONFIG[“TAGS”]`: tags involved in screening (e.g. `[“abs”, ‘posres’, “negres”]`).
  
  - `CONFIG[“DEDUP”]`: de-redundancy policy (`none` / `revcomp` / `revcomp+hamming1`).
  
  - `CONFIG[“OUT_DIR”]`: output directory.

- **Main output (write to `OUT_DIR`)**.    - `filtered_kmers.csv`: the full list of k-mer after passing the threshold and de-redundancy.
  
  - `top{topN}_<tag>.csv`, `top{topN}_alltags.csv`: individual tags sorted by |log2FC| and merged TopN k-mer.
  
  
- `motifs_for_cli.txt`: a comma-separated string of all filtered motifs in a single line, which can be given directly to the command line `-motifs`.  
  - `replacements_for_cli.txt`: the corresponding replacement sequence string, can be used by `--replacements`.
  
  - `motif_replacement_map.csv`: a table mapping motifs to their replacement sequences.
  
  - `summary.json`: record summary information such as input files, thresholds, filtered quantities, and so on.


---

### run_interpretability.py

- **Functional role**    Load the final trained RNA-FM + TokenTransformer model to do systematic in-silico mutations on sequences containing the specified motif:
  
  Enumerate (or sample by motif) the replacement sites in the test set or specified samples, replace the motif with the given alternative sequence, compare the predicted half-lives before and after the mutation, get the effect distribution of each motif/alternative sequence, and output the residual table and simple performance statistics for subsequent interpretability analysis and plotting.

- **Main input**    - `RunParams.EXP_DIR`: the final training directory, must contain `best_model_final.pth`, if there is `final_test_predictions.csv`, it will be prioritized to read directly.
  
  - `RunParams.MUTATION_MODE`: `“full”` (all sequences with motif × all occurrences × all alternative sequences evaluated in full) or `“per-motif”` (at least N entries for each of the motifs sampled).
  
  - `RunParams.NUM_MUTATION_SAMPLES`: `“per-motif”` mode, minimum number of sequences sampled per motif.
  
  
- `RunParams.MOTIFS`: list of motifs to detect/mutate (RNA alphabet).  
  - `RunParams.REPLACEMENTS`: set of alternative sequences corresponding to the motif (of equal length to the motif).
  
  - `Config` consistent with the main model: dataset path, RNA-FM pre-trained model path, max length, batch size, etc.

- **Main output (write to `EXP_DIR/... /result/interpretability_result/<timestamp>/`) **Main output (write to `EXP_DIR/...    - `residuals.csv`: test set sample-level true values, predicted values and residuals.
  
  - `motif_corr.csv`: overview of motif occurrences and residual correlations computed on raw residuals.
  
  - `mutation_results.csv`: in-silico mutation results with per sample, motif, alternative sequence, mutation position, pre/post mutation predictions and `delta` (mut - base).
  
  
- `summary.json`: summary of test set performance (R², Pearson, Spearman) and mutation configuration, etc.  
  - `interpret_env.json`: record of environment parameters such as RunParams / Config used.
  
  - `tensorboard-log/interpretability/`: TensorBoard logs (histogram of residuals, delta distribution, etc.).


---

### analyze_mutation_results.py

- **Functional role**    Systematically analyze and plot `mutation_results.csv` generated by `run_interpretability.py`:
  
  First take the mean of multiple points Δ within each sample to get the “mean Δ per sample”; then summarize the samples by (motif,new), compute the mean, median, bootstrap confidence intervals, and strong response proportions, and correct for this using the Wilcoxon signed-rank test (Δ vs 0) + BH-FDR. Calibration;
  
  Also analyze the relationship between Δ and relative position (motif center / sequence length), baseline half-life (base_pred) stratification, and output multiple thesis-level plots.

- **Primary input**    - `CONFIG.MUTATION_CSV`: `mutation_results.csv` Path.
  
  - `CONFIG.OUT_DIR`: analysis results output directory.
  
  - Statistics/graphing parameters:
  
    - `TOPK`: number of motifs / (motif,new) displayed sorted by |mean_delta|.
  
    - `N_POS_BINS`: number of position bins.
  
    - `N_BOOT`: number of bootstrap times.
  
    - `DPI`, `SAVE_SVG`: image resolution and whether to save SVG.
  
    - `BIG_FRAC_THRESH`: relative change threshold (e.g. Δt/t₀ > 10% is considered “strong response”).
  
    - `N_T0_BINS`: number of bins stratified by baseline prediction.
  
    - `RESIDUALS_CSV` (optional): path to residuals file, leave it blank to default to the same directory `residuals.csv`.
  
    - `USE_RESIDUAL_FILTER`, `RESIDUAL_ABS_THRESH`: whether or not to do extra statistics on low residuals samples only and its threshold.

- **Main output (write to `OUT_DIR`)**.    - Table class:
  
    - `per_sequence_delta.csv`: mean Δ at each sample (sequence) level.
  
    - `mutation_stats_by_motif.csv` / `mutation_stats_by_motif_new.csv`: main effect statistics (mean, median, CI, p-value, FDR, strong response proportion, etc.) aggregated by motif or (motif,new).
  
    - `mutation_stats_by_motif*_goodfit.csv`: like-for-like statistics on a subset of low residual samples only.
  
    - `mutation_stats_by_motif*_t0bins.csv`: statistics on baseline half-life stratification.
  
    - `mutation_position_effect.csv`: position effect correlation statistics (Δ vs relative position).
  
    - `residuals.csv`: if there is residual filtering, the actual residuals used are derived.
  
  - Image (PNG ≥ 400 dpi and optionally SVG):
  
    - Main effects bar chart (sorted by |mean_delta|).
  
    - Δ boxline + jitter plot for each motif/(motif,new).
  
    - Δ line or heatmap of changes in relative position.
  
    - Δ Comparison of effects at different baseline half-life stratifications.
  
    - Volcano diagrams aggregated by motif, etc.
  
  - `summary.json`: overall summary of input files, number of samples, number of motifs, TopK, number of bins etc.


---

### plot_kmer_error_source_summary_v2.py

- **Functional role**    Visualize “error source summary” for k-mer enrichment results:
  
  Read `kmer_enrichment_results_all.csv` (or fall back to a separate k=5/k=6 results file if it doesn't exist) and count the number of k-mer significantly enriched and the effect of the subset of absolute errors, positive residuals (model underestimation), and negative residuals (model overestimation);
  
  Combined with positional heatmaps (e.g., `positional_heatmap_k5*.csv`, `positional_heatmap_k6*.csv`), the peak bin is estimated for each k-mer, and effects and positions are color/bubble-size coded to generate 2×3 bubble plots and significant counts bar graphs.

- **Primary inputs**    - `PATH_RESULTS_ALL` (optional): `kmer_enrichment_results_all.csv` summary table; preferred if present.
  
  - Fallback path (used when no master table exists):
  
    - `PATH_K5_ABS / POS / NEG`: absolute error, positive residual, negative residual enrichment results CSV for k=5.
  
    - `PATH_K6_ABS / POS / NEG`: similar CSV for k=6.
  
  - Position heatmap:
  
    - `PATH_POS_K5_ABS / POS / NEG`: Location heat map CSV for k=5.
  
    - `PATH_POS_K6_ABS / POS / NEG`: Position heatmap CSV for k=6 (if missing, k=6 bubbles are uniformly gray).
  
  - `OUT_PARENT`: output parent directory (script internally creates new subdirectories by timestamp).

- **Main output (write `OUT_PARENT/<timestamp>/`) **    - `kmer_error_source_bubble_grid.png/svg`: 2×3 bubble grid (rows differentiated by k=5/6, columns differentiated by abs/posres/negres), point sizes/color coded for significance and effect, and can be colored by peak position.
  
  - `kmer_sig_counts_bar.png/svg`: bar chart of significant k-mer counts (total/positive/negative) for each panel.
  
  
- `sig_counts_summary.csv`: significant counts and threshold statistics for each panel.  
  - `top_each_cell.csv`: detailed table of TopN k-mer per panel (with log2FC, q, top/bot occurrences, peak bin, etc.).


---

### plots/plot_kmer_enrichment.py

- **Functionality role**    Do enrichment analysis for 5-mer/6-mer driven by the model's prediction error on the test set:
  
  First compute `residual = true - pred` and `abs_error`, then construct a subset of the three categories:
  
  1) top vs bottom by |error|;
  
  2) top vs bottom by |residual| in the subset of “underestimates” with residual > 0;
  
  3) |residual| top vs bottom for the subset of “overestimates” with residuals <0.
  
  Do presence-based enrichment for each class and each k. Calculate log2FC, Fisher's exact test p-value, and FDR, and output volcano plots, bar charts, and normalized location heatmaps, and generate k-mer enrichment CSVs and summary tables for subsequent scripts.

- **Main Input**    - `CONFIG[“RUN_DIR”]`: the model run directory, which needs to contain `final_test_predictions.csv` with at least columns:
  
    - `sequence`: 3′ UTR sequence;
  
    - `true`: true half-life (or transformed target);
  
    - `pred`: model predicted value.
  
  - `CONFIG[“SAVE_SUBDIR”]`: output subdirectory name (e.g. `“kmer_enrichment”`).
  
  - k-mer with mapping parameters:
  
    - `K_LIST`: list of k values (e.g. `[5,6]`).
      - `TOP_PCT`: percentile of error used for top/bottom division (e.g. 10% before and after).      - `ALPHABET`: list of allowed alphabets (e.g. `“ACGU”`).  
    - `MIN_OCC`: filter k-mer with too few total occurrences.
  
    - `FDR_Q`: significance threshold.
  
    - `VOLCANO_TOPN`, `BAR_TOPN`: number of TopNs labeled/displayed in volcano and bar charts.
  
    - `NORM_POS_BINS`: number of normalized segments in the location heat map.
  
    - `HEATMAP_TOPN`: number of k-mer displayed in the location heat map.

- **Main output (write to `<project root>/result/plot/kmer_enrichment/`)**    - CSV:
  
    - `kmer_enrichment_k{k}.csv`: enrichment results grouped by absolute error.
  
    - `kmer_enrichment_k{k}_posres.csv`: enrichment results on the “underestimation” subset.
  
    - `kmer_enrichment_k{k}_negres.csv`: enrichment results on the `overestimation' subset.
  
    
- `kmer_enrichment_results_all.csv`: summary table integrating k, tag, log2FC, q, top/bot occurrences, etc. (for use in subsequent scripts).      - `positional_heatmap_k{k}.csv` and variants with `_posres` / `_negres` suffixes: underlying data for the normalized positional heatmap.  
  - Image (PNG, dpi=400 while saving SVG):
  
    - Volcano maps corresponding to each k, each error type.
      - Bar chart comparing the distribution of errors “with/without k-mer”.  
    - Normalized position heatmap showing the positional distribution of the enriched k-mer on the 3′UTR.
